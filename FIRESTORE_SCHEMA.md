# Firestore Database Schema

## Collections Overview

### 1. **users** Collection
Stores user profile and preferences.

**Document ID**: Firebase Auth UID

**Fields**:
```typescript
{
  uid: string;                      // Firebase Auth UID (matches document ID)
  email: string;                    // User email address
  displayName: string | null;       // Full name
  phoneNumber: string | null;       // Phone number with country code (e.g., +44 7XXX XXXXXX)
  photoURL: string | null;          // Profile picture URL (from Google/Firebase Storage)
  
  preferredPickupLocations: string[]; // Up to 3 favorite pickup locations
  preferredDropoffLocations: string[]; // Up to 3 favorite dropoff locations
  
  createdAt: string;                // ISO 8601 timestamp
  updatedAt: string;                // ISO 8601 timestamp
}
```

**Example**:
```json
{
  "uid": "abc123xyz",
  "email": "user@example.com",
  "displayName": "John Doe",
  "phoneNumber": "+44 7XXX XXXXXX",
  "photoURL": "https://lh3.googleusercontent.com/...",
  "preferredPickupLocations": [
    "Horley, Gatwick RH6 0NP",
    "London Heathrow Airport",
    "Brighton Station"
  ],
  "preferredDropoffLocations": [
    "Porton Down, Salisbury SP4 0JQ",
    "Southampton Airport",
    "Portsmouth City Centre"
  ],
  "createdAt": "2025-11-19T12:00:00.000Z",
  "updatedAt": "2025-11-19T12:30:00.000Z"
}
```

**API Endpoints**:
- `POST /api/users/profile` - Create or update user profile
- `GET /api/users/profile?uid=xxx` - Get user profile

---

### 2. **walletData** Collection
Stores wallet balance for each user.

**Document ID**: Firebase Auth UID (same as users collection)

**Fields**:
```typescript
{
  uid: string;                      // Firebase Auth UID (matches document ID)
  balance: number;                  // Current wallet balance (decimal)
  currency: string;                 // Currency code (e.g., "GBP")
  
  createdAt: string;                // ISO 8601 timestamp
  updatedAt: string;                // ISO 8601 timestamp
}
```

**Example**:
```json
{
  "uid": "abc123xyz",
  "balance": 150.50,
  "currency": "GBP",
  "createdAt": "2025-11-19T12:00:00.000Z",
  "updatedAt": "2025-11-19T14:30:00.000Z"
}
```

**API Endpoints**:
- `GET /api/wallet/:uid` - Get wallet balance
- `POST /api/wallet/transaction` - Create a wallet transaction

---

### 3. **walletTransactions** Collection
Stores transaction history for all wallet operations. This is the **foreign key** reference for `walletData`.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  uid: string;                      // Firebase Auth UID (foreign key to walletData)
  amount: number;                   // Transaction amount (positive number)
  type: 'credit' | 'debit';         // Transaction type
  description: string;              // Human-readable description
  
  metadata: {                       // Additional transaction metadata
    bookingId?: string;             // Related booking ID (if applicable)
    source?: string;                // e.g., "booking_payment", "refund", "top_up"
    [key: string]: any;             // Flexible metadata
  };
  
  balanceBefore: number;            // Wallet balance before transaction
  balanceAfter: number;             // Wallet balance after transaction
  
  createdAt: string;                // ISO 8601 timestamp
}
```

**Example**:
```json
{
  "uid": "abc123xyz",
  "amount": 42.00,
  "type": "debit",
  "description": "Payment for booking CC251119001",
  "metadata": {
    "bookingId": "CC251119001",
    "source": "booking_payment",
    "vehicleType": "MPV"
  },
  "balanceBefore": 150.50,
  "balanceAfter": 108.50,
  "createdAt": "2025-11-19T14:30:00.000Z"
}
```

**API Endpoints**:
- `GET /api/wallet/transactions?uid=xxx&limit=10&offset=0` - Get transaction history
- `POST /api/wallet/transaction` - Create a new transaction (also updates wallet balance)

---

### 4. **bookings** Collection
Stores all booking records.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  bookingReference: string;         // Unique booking reference (e.g., "CC251119001")
  userId: string;                   // Firebase Auth UID (foreign key to users)
  
  from: string;                     // Pickup location
  to: string;                       // Dropoff location
  pickupDateTime: string;           // ISO 8601 timestamp
  
  cabType: 'saloon' | 'estate' | 'mpv' | 'wheelchair';
  passengers: number;               // Number of passengers
  luggage: number;                  // Number of luggage items
  
  fare: number;                     // Total fare amount
  currency: string;                 // Currency code (e.g., "GBP")
  
  status: 'pending' | 'confirmed' | 'completed' | 'cancelled';
  
  customerInfo: {
    name: string;
    email: string;
    phone: string;
    altPhone?: string;
  };
  
  additionalInfo?: {
    flightNumber?: string;
    meetAndGreet?: boolean;
    childSeat?: boolean;
    specialInstructions?: string;
  };
  
  createdAt: string;                // ISO 8601 timestamp
  updatedAt: string;                // ISO 8601 timestamp
}
```

**API Endpoints**:
- `GET /api/bookings` - List bookings (with filters)
- `POST /api/bookings` - Create a new booking

---

### 5. **drivers** Collection
Stores driver information.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  name: string;
  email: string;
  phone: string;
  licenseNumber: string;
  
  vehicleType: 'saloon' | 'estate' | 'mpv' | 'wheelchair';
  vehicleRegistration: string;
  vehicleModel: string;
  
  status: 'active' | 'inactive' | 'on_duty' | 'off_duty';
  
  createdAt: string;
  updatedAt: string;
}
```

**API Endpoints**:
- `GET /api/drivers` - List drivers
- `POST /api/drivers` - Add a new driver

---

### 6. **pricingRules** Collection
Stores fare calculation rules.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  name: string;                     // Rule name/description
  vehicleType: 'saloon' | 'estate' | 'mpv' | 'wheelchair';
  
  baseFare: number;                 // Base fare amount
  perMile: number;                  // Cost per mile
  
  minFare?: number;                 // Minimum fare (optional)
  maxFare?: number;                 // Maximum fare (optional)
  
  active: boolean;                  // Whether this rule is active
  
  createdAt: string;
  updatedAt: string;
}
```

---

## Relationships

```
users (1) ─── (1) walletData
  └── uid matches uid

users (1) ─── (*) bookings
  └── uid matches userId

walletData (1) ─── (*) walletTransactions
  └── uid matches uid (foreign key)

bookings (*) ─── (*) walletTransactions
  └── bookingReference matches metadata.bookingId (optional)
```

---

## Indexes

For optimal query performance, create these Firestore indexes:

1. **walletTransactions**:
   - `uid` (Ascending) + `createdAt` (Descending)

2. **bookings**:
   - `userId` (Ascending) + `createdAt` (Descending)
   - `status` (Ascending) + `createdAt` (Descending)

3. **drivers**:
   - `status` (Ascending) + `vehicleType` (Ascending)

---

## Security Rules

Recommended Firestore security rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Users collection
    match /users/{uid} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow write: if isAuthenticated() && isOwner(uid);
    }
    
    // Wallet data
    match /walletData/{uid} {
      allow read: if isAuthenticated() && isOwner(uid);
      allow write: if false; // Only server can write
    }
    
    // Wallet transactions
    match /walletTransactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write: if false; // Only server can write
    }
    
    // Bookings
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update, delete: if false; // Only admins can modify
    }
    
    // Drivers (read-only for clients)
    match /drivers/{driverId} {
      allow read: if true;
      allow write: if false; // Only admins can write
    }
    
    // Pricing rules (read-only for clients)
    match /pricingRules/{ruleId} {
      allow read: if true;
      allow write: if false; // Only admins can write
    }
  }
}
```

---

## Migration Notes

To migrate existing data or set up initial data:

1. **Initialize user profiles**: When users sign up or sign in with Google, their profile is automatically created in the `users` collection.

2. **Create pricing rules**: Manually add pricing rules via the Firestore console or create an admin API endpoint.

3. **Initialize wallets**: Wallets are created automatically when the first transaction is made for a user.

4. **Set up indexes**: Go to Firestore console → Indexes → Create the indexes mentioned above.

---

## Usage Examples

### Create a new user profile
```typescript
await $fetch('/api/users/profile', {
  method: 'POST',
  body: {
    uid: 'abc123xyz',
    email: 'user@example.com',
    displayName: 'John Doe',
    phoneNumber: '+44 7XXX XXXXXX',
    photoURL: 'https://...',
    preferredPickupLocations: ['Location 1', 'Location 2'],
    preferredDropoffLocations: ['Location A', 'Location B']
  }
});
```

### Add money to wallet
```typescript
await $fetch('/api/wallet/transaction', {
  method: 'POST',
  body: {
    uid: 'abc123xyz',
    amount: 50,
    type: 'credit',
    description: 'Wallet top-up',
    metadata: {
      source: 'stripe_payment',
      paymentIntentId: 'pi_xxxxx'
    }
  }
});
```

### Get wallet balance and transactions
```typescript
// Get balance
const { wallet } = await $fetch(`/api/wallet/abc123xyz`);

// Get transaction history
const { transactions } = await $fetch('/api/wallet/transactions?uid=abc123xyz&limit=20');
```

---

**Last Updated**: November 19, 2025

